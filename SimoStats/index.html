<!DOCTYPE html>
<html ng-app="simoStats">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Simo stats! :D</title>
	<link rel="stylesheet" href="">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="nv.d3.css">
	<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.19/angular.min.js"></script>
	<script src="https://cdn.firebase.com/js/client/1.0.21/firebase.js"></script>
	<script src="https://cdn.firebase.com/libs/angularfire/0.8.2/angularfire.min.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="nv.d3.min.js"></script>
</head>
<body ng-controller="cmdCtrl">

	<ul>
		<li ng-repeat="(key, value) in datas">{{key}}: {{value}}</li>
	</ul>

	<div id="chart">
		<svg style="height:800px;width:1200px;">
		</svg>
	</div>

	<script>
		var app = angular.module("simoStats", ["firebase"]);

		app.controller("cmdCtrl", ['$scope', '$firebase',
			function($scope, $firebase) {
				var ref = new Firebase("https://simocmds.firebaseio.com");
				var sync = $firebase(ref);
				$scope.datas = sync.$asObject();


        $scope.datas.$loaded().then(function() {
          $scope.chartData = [];
          console.log($scope.datas);

          function shapeIt() {
            $scope.barData = {};
            $scope.barData["key"] = "Komentoja ebin";
            $scope.chartData = [];

            angular.forEach($scope.datas, function(val, key) {
              var objToAdd = {};
              objToAdd["label"] = key;
              objToAdd["value"] = val;
              this.push(objToAdd);
            }, $scope.chartData);

            $scope.barData["values"] = $scope.chartData;
          };
          console.log($scope.chartData);

          function retChartData() {
            return $scope.chartData;
          };

          function retBarData() {

            console.log($scope.barData);
            return [$scope.barData];
          };

          function graphIt() {
            nv.addGraph(function() {
              var chart = nv.models.pieChart()
                  .x(function(d) { return d.label })
                  .y(function(d) { return d.value })
                  .showLabels(true);

                d3.select("#chart svg")
                    .datum(retChartData())
                    .transition().duration(350)
                    .call(chart);

              return chart;
            });

          };

          function barIt() {
            nv.addGraph(function() {
              var chart = nv.models.discreteBarChart()
                  .x(function(d) { return d.label })    //Specify the data accessors.
                  .y(function(d) { return d.value })
                  .staggerLabels(true)    //Too many bars and not enough room? Try staggering labels.
                  .tooltips(false)        //Don't show tooltips
                  .showValues(true);       //...instead, show the bar value right on top of each bar.;

              d3.select('#chart svg')
                  .datum(retBarData())
                  .transition().duration(350) 
                  .call(chart);

              nv.utils.windowResize(chart.update);

              return chart;
            });

          };


          $scope.$watch('datas', function(n, o) {
            shapeIt();
            barIt();
          }, true);


        });


				function exampleData() {
				  return  [
				      { 
				        "label": "One",
				        "value" : 29.765957771107
				      } , 
				      { 
				        "label": "Two",
				        "value" : 0
				      } , 
				      { 
				        "label": "Three",
				        "value" : 32.807804682612
				      } , 
				      { 
				        "label": "Four",
				        "value" : 196.45946739256
				      } , 
				      { 
				        "label": "Five",
				        "value" : 0.19434030906893
				      } , 
				      { 
				        "label": "Six",
				        "value" : 98.079782601442
				      } , 
				      { 
				        "label": "Seven",
				        "value" : 13.925743130903
				      } , 
				      { 
				        "label": "Eight",
				        "value" : 5.1387322875705
				      }
				    ];
				}

			}
		]);
	</script>
	
</body>
</html>